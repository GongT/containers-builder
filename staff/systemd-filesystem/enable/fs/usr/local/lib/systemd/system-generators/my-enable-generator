#!/bin/bash
set -Eeuo pipefail

declare -r SOURCE_DIR="/etc/systemd/my/enable"
declare -r TARGET_DIR="${3-/tmp}"
WHO_AM_I=$(realpath "${BASH_SOURCE[0]}")

if [[ ! -d ${SOURCE_DIR} ]]; then
	echo "missing enable define directory: ${SOURCE_DIR}" >/dev/kmsg
	exit 0
fi

AFTERS=()
REQ_ARR=()
WAT_ARR=()

if [[ -e "${SOURCE_DIR}/requires" ]]; then
	mapfile -t REQ_ARR <"${SOURCE_DIR}/requires"
	AFTERS+=("${REQ_ARR[@]}")
fi

if [[ -e "${SOURCE_DIR}/wants" ]]; then
	mapfile -t WAT_ARR <"${SOURCE_DIR}/wants"
	AFTERS+=("${WAT_ARR[@]}")
fi

if [[ ${IN_DEBUG_MODE-no} == yes ]]; then
	exit 0
fi

if [[ ${#AFTERS[@]} -gt 0 ]]; then
	successService=success.service
	mkdir -p "${TARGET_DIR}/${successService}.d"
	{
		echo "# generated by ${WHO_AM_I}"
		echo '[Unit]'
		echo "After=${AFTERS[*]}"
		if [[ ${#REQ_ARR[@]} -gt 0 ]]; then
			echo "SourcePath=${SOURCE_DIR}/requires"
			echo "Requires=${REQ_ARR[*]}"
		fi
		if [[ ${#WAT_ARR[@]} -gt 0 ]]; then
			echo "SourcePath=${SOURCE_DIR}/wants"
			echo "Wants=${WAT_ARR[*]}"
		fi
	} >"${TARGET_DIR}/${successService}.d/enable-require-want.conf"
fi
